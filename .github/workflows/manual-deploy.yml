name: Manual Deploy to AWS Elastic Beanstalk

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-2
  ECR_REPOSITORY: tesis-backend
  EB_APPLICATION_NAME: tesis-backend-app
  EB_ENVIRONMENT_NAME: tesis-backend-env
  S3_BUCKET: elasticbeanstalk-us-east-2-467210048291

jobs:
  deploy:
    name: Deploy to Elastic Beanstalk
    runs-on: ubuntu-latest
    environment: production

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::467210048291:role/GitHubActions-ECR-Role
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Create Dockerrun.aws.json
        run: |
          echo '{
            "AWSEBDockerrunVersion": "1",
            "Image": {
              "Name": "${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}",
              "Update": "true"
            },
            "Ports": [
              {
                "ContainerPort": "8080"
              }
            ]
          }' > Dockerrun.aws.json

      - name: Zip deployment package
        run: |
          # Verificar directorios de configuraci√≥n
          ls -la .ebextensions/ || echo "No .ebextensions"
          ls -la .platform/hooks/postdeploy/ || echo "No .platform hooks"
          # Crear el zip incluyendo configuraciones
          zip -r deploy.zip Dockerrun.aws.json .ebextensions/ .platform/
          # Verificar contenido del zip
          unzip -l deploy.zip

      - name: Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          application_name: ${{ env.EB_APPLICATION_NAME }}
          environment_name: ${{ env.EB_ENVIRONMENT_NAME }}
          version_label: "v-${{ github.sha }}-${{ github.run_number }}"
          region: ${{ env.AWS_REGION }}
          deployment_package: deploy.zip
          existing_bucket_name: ${{ env.S3_BUCKET }}
          use_existing_version_if_available: false
          wait_for_environment_recovery: 60
          aws_access_key: ${{ env.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws_session_token: ${{ env.AWS_SESSION_TOKEN }}

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_install_datadog.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/usr/bin/env bash
      # Do not run on every deployment, only if the agent is not installed.
      if [ -f /etc/datadog-agent/datadog.yaml ]; then
        echo "Datadog agent already installed."
        exit 0
      fi

      # Get the API Key from the Elastic Beanstalk environment variables
      DD_API_KEY=$(/opt/elasticbeanstalk/bin/get-config environment -k DD_API_KEY)

      if [ -z "$DD_API_KEY" ]; then
        echo "DD_API_KEY environment variable not set. Skipping Datadog agent installation."
        exit 0
      fi
      
      echo "Installing Datadog agent..."
      DD_SITE="datadoghq.com" DD_API_KEY=$DD_API_KEY bash -c "$(curl -L https://s3.amazonaws.com/dd-agent/scripts/install_script_agent7.sh)"

      # Enable logs collection
      echo "Configuring Datadog agent for logs..."
      sed -i 's/# logs_enabled: false/logs_enabled: true/' /etc/datadog-agent/datadog.yaml

      # Configure Docker log collection
      mkdir -p /etc/datadog-agent/conf.d/docker.d
      echo "logs:" > /etc/datadog-agent/conf.d/docker.d/conf.yaml
      echo "  - type: docker" >> /etc/datadog-agent/conf.d/docker.d/conf.yaml
      echo "    service: tesis-backend" >> /etc/datadog-agent/conf.d/docker.d/conf.yaml
      echo "    source: java" >> /etc/datadog-agent/conf.d/docker.d/conf.yaml

      # Get environment variables for tags
      DD_ENV=$(/opt/elasticbeanstalk/bin/get-config environment -k DD_ENV)
      DD_SERVICE=$(/opt/elasticbeanstalk/bin/get-config environment -k DD_SERVICE)

      # Add tags to datadog.yaml
      if [ -n "$DD_ENV" ]; then
        echo "env: $DD_ENV" >> /etc/datadog-agent/datadog.yaml
      fi

      if [ -n "$DD_SERVICE" ]; then
        echo "tags:" >> /etc/datadog-agent/datadog.yaml
        echo "  - service:$DD_SERVICE" >> /etc/datadog-agent/datadog.yaml
        echo "  - env:$DD_ENV" >> /etc/datadog-agent/datadog.yaml
      fi

      # Restart the Datadog agent
      echo "Restarting Datadog agent..."
      systemctl restart datadog-agent

      echo "Datadog agent installation and configuration completed."
